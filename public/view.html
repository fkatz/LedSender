<html>

<head>
    <meta name="viewport" content="
         height = device-height,
         width = device-width,
         initial-scale = 1.0,
         minimum-scale = 1.0,
         maximum-scale = 1.0,
         user-scalable = no" />
    <script src="./socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script>
        var socket = io('/', { path: '/socket.io' });
    </script>
    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: var(--color);
            vertical-align: middle;
            user-select: none;
            text-align: center;
            font-family: Sans-Serif;
            padding: 10px;
            margin: 0;
            letter-spacing: 1.2px;
            font-size: 12px;
        }

        .ledSelector {
            width: 100vw;
            padding: 20px;
            max-width: 300px;
            border-radius: 20px;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
            background: white;
        }

        input[type=range] {
            -webkit-appearance: none;
            /* Hides the slider so that custom slider can be made */
            width: 100%;
            padding: 10px;
            /* Specific width is required for Firefox. */
            background: transparent;
            margin-bottom: 10px;
            height: 32px;
            /* Otherwise white in Chrome */
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
        }

        input[type=range]:focus {
            outline: none;
            /* Removes the blue border. You should probably do some kind of focus styling for accessibility reasons though. */
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 32px;
            width: 32px;
            border-radius: 100%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -8px;
            /* You need to specify a margin in Chrome, but in Firefox and IE it is automatic */
            box-shadow: 0px 0px 2px rgba(0, 0, 0, 0.7);
            /* Add cool effects to your sliders! */
        }

        input[type=range]::-moz-range-thumb {
            box-shadow: 0px 0px 1px #000000;
            height: 32px;
            width: 32px;
            margin-top: -2px;
            border-radius: 3px;
            background: #ffffff;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 16.8px;
            cursor: pointer;
            box-shadow: 0px 0px 1px #000000;
            background: #3071a9;
            border-radius: 8.4px;
        }

        input[type=range]#hue::-webkit-slider-runnable-track {
            background: linear-gradient(to right, #ff0000 0%, #ffff00 17%, #00ff00 33%, #00ffff 50%, #0000ff 67%, #ff00ff 83%, #ff0000 100%);
        }

        input[type=range]#sat::-webkit-slider-runnable-track {
            background: linear-gradient(to right, var(--desat) 0%, var(--hue) 100%);
        }

        input[type=range]#val::-webkit-slider-runnable-track {
            background: linear-gradient(to right, #000000 0%, var(--color) 100%);
        }

        input[type=range]#dim::-webkit-slider-runnable-track {
            background: linear-gradient(to right, #000000 0%, #ffffff 100%);
        }

        input[type=range]:focus::-webkit-slider-runnable-track {
            background: inherit;
        }

        input[type=range]::-moz-range-track {
            width: 100%;
            height: 16.8px;
            cursor: pointer;
            box-shadow: 0px 0px 1px #000000;
            background: #3071a9;
            border-radius: 1.3px;
        }

        /* Checkbox */
        .buttonContainer {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: row;
            width: 100%;
            padding-bottom: 10px;
        }

        .buttonContainer span.label {
            display: block;
            margin-right: -6px;
        }

        .container {
            position: relative;
            padding-left: 35px;
            margin-left: 10px;
            top: -8;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Hide the browser's default checkbox */
        .container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        /* Create a custom checkbox */
        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 25px;
            width: 25px;
            background-color: #eee;
        }

        /* On mouse-over, add a grey background color */
        .container:hover input~.checkmark {
            background-color: #ccc;
        }

        /* When the checkbox is checked, add a blue background */
        .container input:checked~.checkmark {
            background-color: #2196F3;
        }

        /* Create the checkmark/indicator (hidden when not checked) */
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        /* Show the checkmark when checked */
        .container input:checked~.checkmark:after {
            display: block;
        }

        /* Style the checkmark/indicator */
        .container .checkmark:after {
            left: 9px;
            top: 5px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            -webkit-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            transform: rotate(45deg);
        }

        input[type="number"] {
            width: 60px;
        }
    </style>
</head>

<body>
    <main>
        <div class="ledSelector">
            <div id="colorController">
                Hue<br>
                <input id="hue" type="range" min="0" max="1" step="0.005" v-model="hue">
                Saturation<br>
                <input id="sat" type="range" min="0" max="1" step="0.005" v-model="sat">
                Brightness<br>
                <input id="val" type="range" min="0" max="1" step="0.005" v-model="val">
            </div>
            <div id="dimController">
                <label>Dim
                    <input id="dim" type="range" min="0" max="1" value="1" step="0.005" v-model="dim">
                </label>
            </div>
            <div class="buttonContainer">
                <span class="label">Rainbow</span>
                <div id="rainbowController">
                    <label class="container">
                        <input id="rainbow" type="checkbox" v-model="state">
                        <span class="checkmark"></span>
                    </label>
                    <!-- ms <input type="number" min="0" step="0.001" v-model.lazy="ms"> -->
                    step <input type="number" step="0.001" v-model.lazy="step">
                </div>
            </div>
            <div class="buttonContainer">
                <span class="label">Pulse</span>
                <div id="pulseController">
                    <label class="container">
                        <input id="pulse" type="checkbox" v-model="state">
                        <span class="checkmark"></span>
                    </label>
                    <!-- ms <input type="number" step="0.001" min="0" v-model.lazy="ms"> -->
                    step <input type="number" step="0.001" v-model.lazy="step">
                </div>
            </div>
        </div>
    </main>
    <script>
        const throttle = (func, limit) => {
            let inThrottle
            return function () {
                const args = arguments
                const context = this
                if (!inThrottle) {
                    func.apply(context, args)
                    inThrottle = true
                    setTimeout(() => inThrottle = false, limit)
                }
            }
        }
        //var isTouching = new Vue({data: {touch:false}});    
        var isTouching = false;
        document.addEventListener("mousedown", () => isTouching = true);
        document.addEventListener("mouseup", () => setTimeout(() => isTouching = false), 500);
        document.addEventListener("touchstart", () => isTouching = true);
        document.addEventListener("touchend", () => setTimeout(() => isTouching = false), 500);
        document.addEventListener("touchcancel", () => setTimeout(() => isTouching = false), 500);
        document.addEventListener("change",()=>{
            console.log("input");
            isTouching = true;
            setTimeout(() => isTouching = false, 500);
        });
        state = {
            color: {
                hsv: []
            },
            rainbow: {
            },
            pulse: {

            }
        };
        var color = new Vue({
            el: '#colorController',
            data: {
                hue: 0.5,
                sat: 1,
                val: 1
            },
            watch: {
                hue() { emit() },
                sat() { emit() },
                val() { emit() },
            }
        });
        var dim = new Vue({
            el: '#dimController',
            data: {
                dim: 1
            },
            watch: {
                dim() { emit() }
            }
        });
        var rainbow = new Vue({
            el: '#rainbowController',
            data: {
                state: true,
                step: 0.01,
                ms: 10
            },
            watch: {
                state() { emit() },
                step() { emit() },
                ms() { emit() }
            }
        });
        var pulse = new Vue({
            el: '#pulseController',
            data: {
                state: true,
                step: 0.01,
                ms: 10
            },
            watch: {
                state() { emit() },
                step() { emit() },
                ms() { console.log("pepe"); emit() }
            }
        });
        satElement = document.getElementById("sat");
        valElement = document.getElementById("val");
        function emit() {
            document.body.style.setProperty("--color", toHex(color.hue, color.sat, color.val));
            valElement.style.setProperty("--color", toHex(color.hue, color.sat, 1));
            satElement.style.setProperty("--hue", toHex(color.hue, 1, 1));
            satElement.style.setProperty("--desat", toHex(color.hue, 0, color.val));

            state.color.hsv[0] = color.hue;
            state.color.hsv[1] = color.sat;
            state.color.hsv[2] = color.val;

            state.dim = dim.dim;

            state.rainbow.state = rainbow.state;
            state.rainbow.ms = rainbow.ms;
            state.rainbow.step = rainbow.step;

            state.pulse.state = pulse.state;
            state.pulse.ms = pulse.ms;
            state.pulse.step = pulse.step;

            if (isTouching) {
                console.log("Sent:")
                console.log(state);
                socket.emit("ledStrip1", JSON.stringify(state));
            }
        }
        socket.on('ledStrip1', function (msg) {
            let newState = JSON.parse(msg);
            console.log("Recieved:")
            console.log(newState);

            if (newState.color != undefined) {
                color.hue = newState.color.h;
                color.sat = newState.color.s;
                color.val = newState.color.v;
            }
            if (newState.dim != undefined) {
                dim.dim = newState.dim;
            }
            if (newState.rainbow != undefined) {
                rainbow.state = newState.rainbow.state;
                rainbow.ms = newState.rainbow.ms;
                rainbow.step = newState.rainbow.step;
            }
            if (newState.pulse != undefined) {
                pulse.state = newState.pulse.state;
                pulse.ms = newState.pulse.ms;
                pulse.step = newState.pulse.step;
            }

        });
        function toHex(h, s, v) {
            var r, g, b;
            var i = Math.floor(h * 6);
            var f = h * 6 - i;
            var p = v * (1 - s);
            var q = v * (1 - f * s);
            var t = v * (1 - (1 - f) * s);

            switch (i % 6) {
                case 0: r = v, g = t, b = p; break;
                case 1: r = q, g = v, b = p; break;
                case 2: r = p, g = v, b = t; break;
                case 3: r = p, g = q, b = v; break;
                case 4: r = t, g = p, b = v; break;
                case 5: r = v, g = p, b = q; break;
                default: r = v, g = p, b = q; break;
            }
            r = Math.round(r * 255);
            g = Math.round(g * 255);
            b = Math.round(b * 255);
            var hex = "#";
            var r = r.toString(16);
            if (r.length < 2) r = "0" + r;
            var g = g.toString(16);
            if (g.length < 2) g = "0" + g;
            var b = b.toString(16);
            if (b.length < 2) b = "0" + b;
            hex += r + g + b;
            return hex;
        }
    </script>
</body>

</html>